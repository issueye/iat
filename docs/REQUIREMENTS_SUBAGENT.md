# Sub-Agent 模块功能优化需求说明文档

## 1. 业务背景与目标

### 1.1 背景

当前 IAT 系统已支持基础的 `call_subagent` 能力，但在实际复杂开发场景中（如重构整个目录或多文件分析），单层同步调用暴露出效率低下、状态不透明及递归不可控等问题。

### 1.2 目标

- **提升协作效率**: 引入异步协作模型，减少主 Agent 的阻塞等待。
- **增强可观测性**: 全程追踪子智能体的思考过程与工具调用过程。
- **保障系统稳定性**: 防止递归调用死循环，建立资源隔离与熔断机制。

---

## 2. 核心问题分析 (Pain Points)

1. **同步阻塞**: 主 Agent 调用子 Agent 后，必须等待其完成所有 turns 才能继续，无法在等待期间处理并行任务。
2. **上下文孤岛**: 子 Agent 仅能接收 `query` 文本，对主会话的历史记录、已发现的代码线索感知较弱。
3. **监控缺失**: UI 层难以区分当前是主 Agent 还是子 Agent 在输出，缺乏分层展示能力。
4. **风险失控**: 子 Agent 如果拥有写权限且无审批，在递归调用中可能引发不可逆的大规模错误。

---

## 3. 优化建议与功能清单

### 3.1 架构层优化

- **异步任务队列**: 将 Sub-Agent 调用转化为一个独立的 Background Task，通过 ID 追踪状态。
- **上下文继承协议**: 支持主 Agent 选择性地将“记忆片段”或“文件句柄”传递给子 Agent。

### 3.2 交互层优化

- **嵌套思维链**: 在 UI 上以嵌套缩进或 Popover 形式展示子 Agent 的 `<think>` 内容。
- **实时流透传**: 子 Agent 的输出应实时流式反馈给主 Agent，主 Agent 可根据中间结果提前终止子任务。

### 3.3 安全与治理

- **递归深度限制 (TTL)**: 默认限制子 Agent 嵌套层级（建议最大 3 层）。
- **权限降级机制**: 子 Agent 默认不继承物理删除权限，仅保留读取和建议修改权限。

---

## 4. 衡量指标 (Success Metrics)

- **任务完成率 (Task Success Rate)**: 复杂任务（涉及 3 个以上文件）的自动修补成功率提升 20%。
- **响应速度**: 主 Agent 的平均闲置等待时间降低 40%。
- **用户满意度**: 通过 UI 实时反馈，减少用户对“程序卡死”的误判。

---

**编写者**: Antigravity (PM Mode)
**日期**: 2026-01-23
