# 产品需求文档 (PRD): Sub-Agent 异步协作与可观测性优化

## 1. 文档信息

- **版本**: v1.0
- **状态**: 草案
- **编写人**: Antigravity (PM Mode)
- **日期**: 2026-01-23

---

## 2. 项目背景与目标

### 2.1 背景

当前 Sub-Agent 调用为同步模式，导致大模型在进行多步决策时，主界面长时间处于“等待工具返回”状态，用户体验差且无法中止无效递归。

### 2.2 目标

1. 实现 Sub-Agent 的异步调用与流式感知。
2. 提供完善的子任务生命周期管理。
3. 建立多层级调用的资源与安全边界。

---

## 3. 需求详解

### 3.1 核心功能：异步协作模型 (Async Collaboration)

- **[F01] 任务 ID 化**: 每一个 `call_subagent` 调用均生成唯一的 `TaskID`。
- **[F02] 非阻塞执行**: 主 Agent 发起调用后，可选择 `wait=true` (同步) 或 `wait=false` (异步)。
- **[F03] 轮询与回调**: 主 Agent 可通过 `check_subagent_status(taskID)` 获取进度，或在子任务结束时接收系统通知。

### 3.2 核心功能：嵌套流式反馈 (Nested Streaming)

- **[F04] 实时日志透传**: 子 Agent 的所有产生的内容 (Thought, Tool Call, Output) 必须带上 `parent_task_id` 实时推送到前端。
- **[F05] UI 分层渲染**: 前端识别消息层级，使用嵌套卡片或树状视图展示子智能体的活动，避免与主会话信息流混淆。

### 3.3 核心功能：治理与安全 (Governance)

- **[F06] 递归深度阈值**: 全局配置 `SUBAGENT_MAX_DEPTH`，默认为 3。超过深度时，系统强制返回错误。
- **[F07] 权限沙箱**:
  - 子 Agent 默认禁止执行 `rm -rf` 或修改关键系统配置。
  - 引入 `trust_level` 机制，低信任度 Agent 调用工具前必须由主 Agent 或用户确认。
- **[F08] 自动终止机制**: 若父会话被用户中止，应连锁中止所有关联的子 Agent 运行。

---

## 4. UI/UX 逻辑描述

1. **启动态**: 当 Agent 发起 `call_subagent` 时，消息流中出现一个 loading 卡片，标识“正在召唤：[AgentName]”。
2. **运行态**:
   - 卡片可展开，展示子 Agent 的思考逻辑。
   - 提供“中止此子任务”按钮，不影响主任务运行。
3. **完成态**: 结果以摘要形式展示在卡片顶部，点击可查看完整过程。

---

## 5. 非功能性需求

- **性能**: Sub-Agent 启动延迟应控制在 500ms 以内（本地初始化）。
- **稳定性**: 即使子 Agent 奔溃（Crash），不应导致 `engine` 主进程退出，需通过 `recover` 捕获并将错误上报至父 Agent。
- **并发性**: 支持同时运行最多 5 个并行的异步 Sub-Agent（受 Token 消耗速率和线程限制）。

---

## 6. 验收标准 (Acceptance Criteria)

1. 成功演示一个主 Agent 调用“代码专家”进行分析，同时调用“文档专家”整理注释的并行过程。
2. 验证当递归深度达到 4 时，系统能够准确报错并停止，不发生 OOM。
3. 验证中止父会话后，所有子 Agent 进程及其产生的临时任务已清理。

---

**备注**: 此 PRD 为优化方向指导，部分涉及 A2A 标准协议的内容需配合 `golang_agent` 模块进一步细化。
